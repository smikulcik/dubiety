<html>
<head>
	<script src='https://code.jquery.com/jquery-3.1.1.min.js'></script>
	<script src='./js/chat.js'></script>
	<link rel="stylesheet" type="text/css" href='./css/chat.css' />
</head>
<body>
	<h1>Dubiety</h1>
	<div class='chat'></div>
	<form id=analyzer>
		<h3>Sentiment Analysis</h3>
		<input />
		<button type=submit id='analyzeBtn'>Analyze</button>
		<div id='analyzeOutput'></div>
	</form>
	<script>
		var getwsurl = function(path){
			var loc = window.location, new_uri;
			if (loc.protocol === "https:") {
				new_uri = "wss:";
			} else {
				new_uri = "ws:";
			}
			new_uri += "//" + loc.host;
			new_uri += loc.pathname + path;
			return new_uri;
		}

		var Session = function(){
			this.ws;
			this.token;
			this.reconnect();
		};
		Session.prototype.send = function(message, errback){
			if(this.token !== undefined) {
				this.ws.send(JSON.stringify({'token': this.token, 'msg': message}));
			} else {
				if(errback !== undefined)
					errback();
			}
		};
		Session.prototype.reconnect = function(){
			var that = this;
			console.log("Opening connection");
			this.ws = new WebSocket(getwsurl("ws"));

			this.ws.onmessage = function(evt) {
				var json = JSON.parse(evt.data);
				if(json.hasOwnProperty('token') && that.token !== json.token) {
					that.token = json.token;
					console.log("setting token");
					this.send(JSON.stringify({'token': that.token}));
				}
				if(json.hasOwnProperty('msg')){
					chat.Chat.receiveMsg(json.msg, "Anton");
				}
			};

			this.ws.onopen = function()
			{
				console.log("Connected");
				// request token
				if(that.token === undefined)
					this.send("{}");
			};

			this.ws.onclose = function()
			{
				console.log("Disconnected, attepting to reconnect");
				setTimeout(function(){that.reconnect()}, 50);
			}

		};

		var session = new Session();

		var chat = $('.chat');
		chat.Chat("Jeff Jacobs", function(msg){
			session.send(msg);
		});
		$('#analyzer button').click(function(evt){
			evt.preventDefault();
			var input = $('#analyzer input').val();
			$.post('./analyze', {text: input}, function(res){
				$('#analyzer div').text(res);
			});
		});
	</script>
</body>
</html>
