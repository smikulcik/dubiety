<html>
<head>
	<script src='https://code.jquery.com/jquery-3.1.1.min.js'></script>
	<script src='./js/chat.js'></script>
	<script src='./js/dashboard.js'></script>
	<link rel="stylesheet" type="text/css" href='./css/chat.css' />
	<link rel="stylesheet" type="text/css" href='./css/dubiety.css' />
</head>
<body>
	<h1 class='title'>Dubiety</h1>
	<table class=game><tr>
		<td><div class='chat'></div></td>
		<td>
			<div class='dashboard'>
				<div class='loginPrompt'>
					<span class='white'>Remote Dashboard</span><br/>
						<form>
							<input class='passcodeInput' />
							<button class='connectBtn'>Connect</button>
						</form>
				</div>
				<div class='dashboardDisplay'>
					<h1>Remote Dashboard</h1>
					<div class='status'>
						<h3>Astronaut Status</h3>
						<span>Health: </span><span class='health ok'>Normal</span><br/>
						<span>Heart Rate: </span><span class='heartRate'>60</span>bpm

						<h3>Ship Status</h3>
						<div>
						<div class='lights'>
							<h4>Cabin Lights</h4>
							<span>Status: </span><span class='state ok'>Normal</span><br/>
							<span>Action: </span><span class='action'>None</span>
						</div>
						<div class='ventilation'>
							<h4>Ventilation System</h4>
							<span>Status: </span><span class='state ok'>Normal</span><br/>
							<span>Action: </span><span class='action'>None</span>
						</div>
					</div>
				</div>
			</div>
		</td>
	</tr></table>
	<script>

		var dashboard = $('.dashboard');
		dashboard.Dashboardify();
		var getwsurl = function(path){
			var loc = window.location, new_uri;
			if (loc.protocol === "https:") {
				new_uri = "wss:";
			} else {
				new_uri = "ws:";
			}
			new_uri += "//" + loc.host;
			new_uri += loc.pathname + path;
			return new_uri;
		}

		var Session = function(){
			this.ws;
			this.token;
			this.reconnect();
		};
		Session.prototype.send = function(message, errback){
			if(this.token !== undefined) {
				this.ws.send(JSON.stringify({'token': this.token, 'msg': message}));
			} else {
				if(errback !== undefined)
					errback();
			}
		};
		Session.prototype.reconnect = function(){
			var that = this;
			console.log("Opening connection");
			this.ws = new WebSocket(getwsurl("ws"));

			this.ws.onmessage = function(evt) {
				var json = JSON.parse(evt.data);
				if(json.hasOwnProperty('token') && that.token !== json.token) {
					that.token = json.token;
					console.log("setting token");
					this.send(JSON.stringify({'token': that.token}));
				}
				if(json.hasOwnProperty('msg')){
					chat.Chat.receiveMsg(json.msg, "Anton");
				}
				if(json.hasOwnProperty('state')){
					dashboard.Dashboardify.update(json.state);
				}
			};

			this.ws.onopen = function()
			{
				console.log("Connected");
				// request token
				if(that.token === undefined)
					this.send("{}");
			};

			this.ws.onclose = function()
			{
				console.log("Disconnected, attepting to reconnect");
				setTimeout(function(){that.reconnect()}, 50);
			}

		};

		var session = new Session();

		var chat = $('.chat');
		chat.Chat("Jeff Jacobs", function(msg){
			session.send(msg);
		});
		</script>
</body>
</html>
